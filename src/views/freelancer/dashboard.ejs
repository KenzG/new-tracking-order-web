<!-- HEADER -->
<div class="bg-light border-b border-slate-200">
  <div class="max-w-7xl mx-auto py-12 px-6">
    <div class="flex items-center gap-3">
      <svg class="w-8 h-8 text-teal-600" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"></path></svg>
      <div>
        <h1 class="text-4xl font-bold text-teal-600">Dashboard</h1>
      </div>
    </div>
    <p class="text-slate-600 mt-2">Manage your projects and track orders</p>
  </div>
</div>

<div class="max-w-7xl mx-auto py-10 px-6">
  <!-- STATS CARDS (CLICKABLE FOR FILTERING) -->
  <div class="grid md:grid-cols-4 gap-6 mb-10">
    <!-- Total Projects Card -->
    <button type="button" class="stat-filter-btn bg-blue-50 card-border rounded-lg p-6 hover:border-blue-500/60 transition cursor-pointer border-blue-600/30" data-filter="all">
      <div class="flex items-center justify-between text-left">
        <div>
          <p class="text-blue-700 text-sm font-medium">Total Projects</p>
          <h2 class="text-3xl font-bold text-slate-900 mt-2"><%= stats.totalProjects %></h2>
        </div>
        <div class="w-12 h-12 bg-blue-600/10 rounded-lg flex items-center justify-center border border-blue-600/30">
          <svg class="w-6 h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm0 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6z"></path></svg>
        </div>
      </div>
    </button>

    <!-- In Progress Card -->
    <button type="button" class="stat-filter-btn bg-yellow-50 card-border rounded-lg p-6 hover:border-yellow-500/60 transition cursor-pointer border-yellow-600/30" data-filter="active">
      <div class="flex items-center justify-between text-left">
        <div>
          <p class="text-yellow-700 text-sm font-medium">In Progress</p>
          <h2 class="text-3xl font-bold text-slate-900 mt-2"><%= stats.activeProjects %></h2>
        </div>
        <div class="w-12 h-12 bg-yellow-600/10 rounded-lg flex items-center justify-center border border-yellow-600/30">
          <svg class="w-6 h-6 text-yellow-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.107a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.107a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
        </div>
      </div>
    </button>

    <!-- Pending Projects Card -->
    <button type="button" class="stat-filter-btn bg-amber-50 card-border rounded-lg p-6 hover:border-amber-500/60 transition cursor-pointer border-amber-600/30" data-filter="pending">
      <div class="flex items-center justify-between text-left">
        <div>
          <p class="text-amber-700 text-sm font-medium">Pending</p>
          <h2 class="text-3xl font-bold text-slate-900 mt-2"><%= stats.pendingProjects %></h2>
        </div>
        <div class="w-12 h-12 bg-amber-600/10 rounded-lg flex items-center justify-center border border-amber-600/30">
          <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.707-10.707a1 1 0 00-1.414-1.414l-3 3a1 1 0 001.414 1.414L9 9.414l2.293 2.293a1 1 0 001.414-1.414l-3-3z" clip-rule="evenodd"></path></svg>
        </div>
      </div>
    </button>

    <!-- Completed Card -->
    <button type="button" class="stat-filter-btn bg-green-50 card-border rounded-lg p-6 hover:border-green-500/60 transition cursor-pointer border-green-600/30" data-filter="completed">
      <div class="flex items-center justify-between text-left">
        <div>
          <p class="text-green-700 text-sm font-medium">Completed</p>
          <h2 class="text-3xl font-bold text-slate-900 mt-2"><%= stats.completedProjects %></h2>
        </div>
        <div class="w-12 h-12 bg-green-600/10 rounded-lg flex items-center justify-center border border-green-600/30">
          <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>
        </div>
      </div>
    </button>
  </div>

  <!-- PROJECTS SECTION -->
  <div class="bg-light card-border rounded-lg p-8">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl font-bold text-slate-900">Your Projects</h2>
      <a href="/projects/new" class="btn-teal px-6 py-2 rounded-lg text-sm font-semibold hover:bg-teal-700 transition">
        + New Project
      </a>
    </div>

    <% if (projects && projects.length > 0) { %>
      <div class="space-y-3">
        <% projects.forEach((project) => { %>
          <% 
            const pendingOrders = project.orders.filter(o => o.status === 'PENDING').length;
            const inProgressOrders = project.orders.filter(o => o.status === 'IN_PROGRESS').length;
            const completedOrders = project.orders.filter(o => o.status === 'COMPLETED').length;
            const totalOrders = project.orders.length;
            const isCompleted = totalOrders > 0 && project.orders.every(o => o.status === 'COMPLETED');
            const isActive = project.orders.some(o => o.status === 'IN_PROGRESS');
            const projectStatus = isCompleted ? 'completed' : isActive ? 'active' : 'pending';
          %>
          <div class="project-card bg-slate-50 rounded-lg p-6 border border-slate-200 hover:border-slate-300 transition flex items-center justify-between group" data-status="<%= projectStatus %>">
            <div class="flex-1">
              <h3 class="font-semibold text-slate-900 text-lg"><%= project.title %></h3>
              <p class="text-slate-600 text-sm mt-2"><%= project.description || 'No description' %></p>
              <p class="text-slate-500 text-xs mt-2">
                Client: <%= project.clientName || project.owner.name %>
                <% if (project.deadline) { %> | Due: <%= new Date(project.deadline).toLocaleDateString() %><% } %>
              </p>
              <p class="text-xs mt-1">
                <% if (project.accessToken) { %>
                  <button type="button" class="view-client-link-btn text-teal hover:underline text-xs" data-project-id="<%= project.id %>" data-token="<%= project.accessToken %>">View Client Link</button>
                <% } else { %>
                  <form action="/projects/<%= project.id %>/token/regenerate" method="post" class="inline">
                    <button type="submit" class="text-sm px-2 py-1 bg-yellow-500 text-white rounded">Generate Link</button>
                  </form>
                <% } %>
              </p>
              
              <!-- ORDER STATS -->
              <div class="flex flex-wrap gap-2 mt-4">
                <span class="text-xs bg-slate-200 text-slate-700 px-3 py-1 rounded border border-slate-300">üìä <%= totalOrders %> Orders</span>
                <% if (pendingOrders > 0) { %>
                  <span class="text-xs bg-yellow-100 text-yellow-700 px-3 py-1 rounded border border-yellow-300">‚è≥ <%= pendingOrders %> Pending</span>
                <% } %>
                <% if (inProgressOrders > 0) { %>
                  <span class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded border border-emerald-300">‚ö° <%= inProgressOrders %> Active</span>
                <% } %>
                <% if (completedOrders > 0) { %>
                  <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded border border-green-300">‚úì <%= completedOrders %> Done</span>
                <% } %>
              </div>
            </div>
            
            <div class="flex items-center gap-3 ml-6">
              <a href="/projects/<%= project.id %>" class="px-4 py-1.5 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300 transition">
                Manage
              </a>
              <button type="button" class="edit-project-btn px-4 py-1.5 bg-slate-200 text-slate-700 rounded-lg text-sm font-medium hover:bg-slate-300 transition" data-project-id="<%= project.id %>">
                Edit
              </button>
            </div>
          </div>
        <% }); %>
      </div>
    <% } else { %>
      <div class="text-center py-12">
        <p class="text-slate-600 text-lg">No projects yet.</p>
      </div>
    <% } %>
  </div>
</div>

<!-- Client Link Modal -->
<div id="client-link-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
    <h3 class="text-lg font-semibold text-slate-900 mb-4">Client Access Link</h3>
    <p class="text-sm text-slate-600 mb-3">Share this link with your client:</p>
    <div class="flex items-center gap-2 mb-4">
      <code id="client-link-text" class="flex-1 bg-slate-100 p-2 rounded text-sm font-mono text-slate-700">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
      <button id="reveal-link-btn" type="button" class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">show</button>
    </div>
    <button id="copy-link-btn" type="button" class="w-full px-4 py-2 bg-teal-600 text-white rounded mb-2 text-sm hover:bg-teal-700">Copy Full URL</button>
    <button id="close-link-modal" type="button" class="w-full px-4 py-2 bg-slate-300 text-slate-700 rounded text-sm hover:bg-slate-400">Close</button>
  </div>
</div>

<!-- Edit Project Modal -->
<div id="edit-project-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full">
    <h3 class="text-lg font-semibold text-slate-900 mb-4">Edit Project</h3>
    <form id="edit-project-form" class="space-y-3">
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Title</label>
        <input id="edit-title" type="text" required class="w-full rounded-md border border-slate-300 p-2 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
        <textarea id="edit-description" rows="2" class="w-full rounded-md border border-slate-300 p-2 text-sm"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Client Name</label>
        <input id="edit-clientName" type="text" class="w-full rounded-md border border-slate-300 p-2 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Client Email</label>
        <input id="edit-clientEmail" type="email" class="w-full rounded-md border border-slate-300 p-2 text-sm" />
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Deadline</label>
        <input id="edit-deadline" type="date" class="w-full rounded-md border border-slate-300 p-2 text-sm" />
      </div>
      <div class="flex gap-2 pt-4">
        <button type="submit" class="flex-1 px-4 py-2 bg-teal-600 text-white rounded text-sm font-medium hover:bg-teal-700">Save</button>
        <button id="close-edit-modal" type="button" class="flex-1 px-4 py-2 bg-slate-300 text-slate-700 rounded text-sm font-medium hover:bg-slate-400">Cancel</button>
      </div>
      <button id="delete-project-btn" type="button" class="w-full px-4 py-2 bg-red-500 text-white rounded text-sm font-medium hover:bg-red-600 mt-2">Delete Project</button>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
    <p id="confirm-message" class="text-slate-700 mb-4"></p>
    <div class="flex justify-end gap-2">
      <button id="confirm-cancel" class="px-4 py-2 bg-slate-300 rounded hover:bg-slate-400">Cancel</button>
      <button id="confirm-ok" class="px-4 py-2 bg-teal-600 text-white rounded hover:bg-teal-700">OK</button>
    </div>
  </div>
</div>

<script>
    function filterProject(status) {
        const cards = document.querySelectorAll('.project-card');
        const statBtns = document.querySelectorAll('.stat-filter-btn');

        cards.forEach(card => {
            const cardStatus = card.getAttribute('data-status');
            if (status === 'all' || cardStatus === status) {
                card.style.display = "flex";
            } else {
                card.style.display = "none";
            }
        });

        statBtns.forEach(btn => {
            btn.classList.remove("ring-2", "ring-teal-500");
            if (btn.getAttribute('data-filter') === status) {
                btn.classList.add("ring-2", "ring-teal-500");
            }
        });
    }

    window.onload = function() {
        filterProject("all");
    }

    document.querySelectorAll('.stat-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');
        filterProject(filter);
      });
    });

    function showConfirm(message) {
      return new Promise(resolve => {
        const modal = document.getElementById('confirm-modal');
        const msgEl = document.getElementById('confirm-message');
        const okBtn = document.getElementById('confirm-ok');
        const cancelBtn = document.getElementById('confirm-cancel');
        msgEl.textContent = message;
        modal.classList.remove('hidden');
        const cleanup = () => {
          okBtn.removeEventListener('click', okHandler);
          cancelBtn.removeEventListener('click', cancelHandler);
          modal.classList.add('hidden');
        };
        const okHandler = () => { cleanup(); resolve(true); };
        const cancelHandler = () => { cleanup(); resolve(false); };
        okBtn.addEventListener('click', okHandler);
        cancelBtn.addEventListener('click', cancelHandler);
      });
    }

    document.querySelectorAll('.view-client-link-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const token = btn.getAttribute('data-token');
        const modal = document.getElementById('client-link-modal');
        document.getElementById('client-link-text').textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
        document.getElementById('reveal-link-btn').textContent = 'show';
        modal.classList.remove('hidden');
        
        document.getElementById('reveal-link-btn').onclick = () => {
          if (document.getElementById('client-link-text').textContent.includes('‚Ä¢')) {
            document.getElementById('client-link-text').textContent = `/client/${token}`;
            document.getElementById('reveal-link-btn').textContent = 'copy';
          } else {
            navigator.clipboard.writeText(`/client/${token}`);
            document.getElementById('reveal-link-btn').textContent = 'copied';
            setTimeout(() => { document.getElementById('reveal-link-btn').textContent = 'copy'; }, 1500);
          }
        };
        
        document.getElementById('copy-link-btn').onclick = () => {
          navigator.clipboard.writeText(window.location.origin + `/client/${token}`);
          document.getElementById('copy-link-btn').textContent = 'copied';
          setTimeout(() => { document.getElementById('copy-link-btn').textContent = 'Copy Full URL'; }, 1500);
        };
        
        document.getElementById('close-link-modal').onclick = () => {
          modal.classList.add('hidden');
        };
      });
    });

    document.querySelectorAll('.edit-project-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        const projectId = btn.getAttribute('data-project-id');
        try {
          const response = await fetch(`/projects/${projectId}/edit-data`);
          const data = await response.json();
          document.getElementById('edit-title').value = data.title || '';
          document.getElementById('edit-description').value = data.description || '';
          document.getElementById('edit-clientName').value = data.clientName || '';
          document.getElementById('edit-clientEmail').value = data.clientEmail || '';
          document.getElementById('edit-deadline').value = data.deadline || '';
          document.getElementById('edit-project-form').setAttribute('data-project-id', projectId);
          document.getElementById('edit-project-modal').classList.remove('hidden');
        } catch (err) {
          alert('Error: ' + err.message);
        }
      });
    });

    document.getElementById('edit-project-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const projectId = e.target.getAttribute('data-project-id');
      try {
        const response = await fetch(`/projects/${projectId}/edit`, {
          method: 'POST',
          headers: { 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            title: document.getElementById('edit-title').value,
            description: document.getElementById('edit-description').value,
            clientName: document.getElementById('edit-clientName').value,
            clientEmail: document.getElementById('edit-clientEmail').value,
            deadline: document.getElementById('edit-deadline').value
          })
        });
        const data = await response.json();
        if (data.status === 'ok') location.reload();
        else alert('Error: ' + (data.message || 'Failed'));
      } catch (err) {
        alert('Error: ' + err.message);
      }
    });

    document.getElementById('delete-project-btn')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const projectId = document.getElementById('edit-project-form').getAttribute('data-project-id');
      if (await showConfirm('Delete this project? This cannot be undone.')) {
        try {
          const response = await fetch(`/projects/${projectId}/delete`, {
            method: 'POST',
            headers: { 'Accept': 'application/json' }
          });
          const data = await response.json();
          if (data.status === 'ok') location.href = '/';
          else alert('Error: ' + (data.message || 'Failed'));
        } catch (err) {
          alert('Error: ' + err.message);
        }
      }
    });

    document.getElementById('close-edit-modal')?.addEventListener('click', () => {
      document.getElementById('edit-project-modal').classList.add('hidden');
    });
</script>


